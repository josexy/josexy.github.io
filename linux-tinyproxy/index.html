<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
















  
  
    
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Sans SC:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext">
  






<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=7.2.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.2.0',
    sidebar: {"position":"right","display":"hide","offset":12,"onmobile":true},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="本文将利用CentOS、TinyProxy、Stunnel搭建一个正向代理服务器…">
<meta name="keywords" content="Linux,CentOS,TinyProxy,HTTP,HTTPS">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS+TinyProxy+Stunnel配置HTTP代理服务器">
<meta property="og:url" content="http://www.joxrays.com/linux-tinyproxy/index.html">
<meta property="og:site_name" content="JoXrays&#39;s Blog">
<meta property="og:description" content="本文将利用CentOS、TinyProxy、Stunnel搭建一个正向代理服务器…">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://www.joxrays.com/uploads/images/tinyproxy_stunnel/01.png">
<meta property="og:image" content="http://www.joxrays.com/uploads/images/tinyproxy_stunnel/02.png">
<meta property="og:image" content="http://www.joxrays.com/uploads/images/tinyproxy_stunnel/03.png">
<meta property="og:image" content="http://www.joxrays.com/uploads/images/tinyproxy_stunnel/04.png">
<meta property="og:updated_time" content="2020-02-17T15:26:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CentOS+TinyProxy+Stunnel配置HTTP代理服务器">
<meta name="twitter:description" content="本文将利用CentOS、TinyProxy、Stunnel搭建一个正向代理服务器…">
<meta name="twitter:image" content="http://www.joxrays.com/uploads/images/tinyproxy_stunnel/01.png">



  <link rel="alternate" href="/atom.xml" title="JoXrays's Blog" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://www.joxrays.com/linux-tinyproxy/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>CentOS+TinyProxy+Stunnel配置HTTP代理服务器 | JoXrays's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-duotone-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JoXrays's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">All my interesting ...</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.joxrays.com/linux-tinyproxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Joseph XRays">
      <meta itemprop="description" content="Share the knowledge">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JoXrays's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">CentOS+TinyProxy+Stunnel配置HTTP代理服务器

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-02-17 00:00:00 / 修改时间：23:26:52" itemprop="dateCreated datePublished" datetime="2020-02-17T00:00:00+08:00">2020-02-17</time>
            </span>
          

          
            

            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">6.5k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">6 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文将利用CentOS、TinyProxy、Stunnel搭建一个正向代理服务器…</p>
<a id="more"></a>
<p>之前的 <a href="https://www.joxrays.com/centos-shadowsocks/">CentOS服务器Shadowsocks</a> 是在CentOS7上配置Shadowsocks将其作为代理服务器，而这次的tinyproxy配置同样也是把CentOS7作为一个代理服务器，而且SS是基于Socks5协议，tinyproxy是HTTP/HTTPS协议。</p>
<h3 id="tinyproxy"><a class="markdownIt-Anchor" href="#tinyproxy"></a> TinyProxy</h3>
<p>TinyProxy是一个由C语言开发、开源、轻量级的HTTP/HTTPS代理服务器 <a href="https://github.com/tinyproxy/tinyproxy" target="_blank" rel="noopener">Github</a></p>
<blockquote>
<p>Tinyproxy is a light-weight HTTP/HTTPS proxy daemon for POSIX operating systems. Designed from the ground up to be fast and yet small, it is an ideal solution for use cases such as embedded deployments where a full featured HTTP proxy is required, but the system resources for a larger proxy are unavailable.</p>
</blockquote>
<p>tinyproxy比squid配置要简单，但squid功能却比tinyproxy要多且灵活性高。不过我对squid不是很深入了解，暂时就拿tinyproxy来说吧。<br>
由于我的服务器是CentOS7，故可直接从包管理器安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># yum install -y tinyproxy</span></span><br></pre></td></tr></table></figure>
<p>之后就是配置tinyproxy了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># vim /etc/tinyproxy/tinyproxy.conf</span></span><br></pre></td></tr></table></figure>
<p>修改tinyproxy监听端口<code>Port</code>，默认 <code>8888</code><br>
注释<code>Allow</code>参数，表示允许所有人都可以访问代理服务器。如果只希望指定的IP能够访问代理服务器，那么可以添加多个<code>Allow</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Port 8888</span><br><span class="line"><span class="comment">#Allow 127.0.0.1</span></span><br><span class="line">Allow 10.10.6.0/24</span><br><span class="line">Allow 123.200.123.66</span><br></pre></td></tr></table></figure>
<p>注意 <code>#DisableViaHeader Yes</code> 这个参数，用于指定是否在请求Header中显示tinyproxy相关信息（比如：<code>Proxy-agent: tinyproxy/1.8.3</code>），默认是关闭的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ViaProxyName: The "Via" header is required by the HTTP RFC, but using</span></span><br><span class="line"><span class="comment"># the real host name is a security concern.  If the following directive</span></span><br><span class="line"><span class="comment"># is enabled, the string supplied will be used as the host name in the</span></span><br><span class="line"><span class="comment"># Via header; otherwise, the server's host name will be used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#ViaProxyName "tinyproxy"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># DisableViaHeader: When this is set to yes, Tinyproxy does NOT add</span></span><br><span class="line"><span class="comment"># the Via header to the requests. This virtually puts Tinyproxy into</span></span><br><span class="line"><span class="comment"># stealth mode. Note that RFC 2616 requires proxies to set the Via</span></span><br><span class="line"><span class="comment"># header, so by enabling this option, you break compliance.</span></span><br><span class="line"><span class="comment"># Don't disable the Via header unless you know what you are doing...</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#DisableViaHeader Yes</span></span><br></pre></td></tr></table></figure>
<p>其他参数默认即可，之后就是启动tinyproxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># systemctl start tinyproxy.service</span></span><br><span class="line">[root@VM_0_17_centos ~]<span class="comment"># systemctl enable tinyproxy.service</span></span><br></pre></td></tr></table></figure>
<p>配置iptables</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许访问</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 8888 -j ACCEPT</span><br><span class="line"><span class="comment"># 拒绝访问</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 8888 -j REJECT</span><br></pre></td></tr></table></figure>
<p>可能还需要配置云服务器安全组外界才能访问tinyproxy端口</p>
<p>之后就能够直接通过该代理服务器进行代理访问了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">% curl -x 129.204.152.8:8888 https://ip.cn --head</span><br><span class="line">HTTP/1.0 200 Connection established</span><br><span class="line">Proxy-agent: tinyproxy/1.8.3</span><br><span class="line"></span><br><span class="line">HTTP/2 200 </span><br><span class="line">date: Mon, 17 Feb 2020 02:08:20 GMT</span><br><span class="line">content-type: application/json; charset=UTF-8</span><br><span class="line"><span class="built_in">set</span>-cookie: __cfduid=d404e02d9f8749f3815ce40da97e29bbf1581905300; expires=Wed, 18-Mar-20 02:08:20 GMT; path=/; domain=.ip.cn; HttpOnly; SameSite=Lax</span><br><span class="line">cf-cache-status: DYNAMIC</span><br><span class="line">expect-ct: max-age=604800, report-uri=<span class="string">"https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"</span></span><br><span class="line">server: cloudflare</span><br><span class="line">cf-ray: 5664367e282eeba9-LAX</span><br></pre></td></tr></table></figure>
<p>当然也可以 <code>curl -x 129.204.152.8:8888 https://ip.cn --head -k</code>，即允许curl使用非安全的ssl连接并且传输数据（证书不受信）。<br>
注意 <code>Proxy-agent: tinyproxy/1.8.3</code> ，之前我们并没有注释 <code>#DisableViaHeader Yes</code>，它会在Via请求中显示代理信息。<br>
查看日志log <code>tail /var/log/tinyproxy/tinyproxy.log</code>。</p>
<p>然而事情并没有结束…</p>
<h3 id="stunnel隧道"><a class="markdownIt-Anchor" href="#stunnel隧道"></a> Stunnel(隧道)</h3>
<blockquote>
<p>Stunnel是一个自由的跨平台软件，用于提供全局的TLS/SSL服务。针对本身无法进行TLS或SSL通信的客户端及服务器，Stunnel可提供安全的加密连接。</p>
</blockquote>
<p>如果用代理服务器访问一个HTTP协议的网站，那么传输的数据是不会加密的，也就是说可以被抓包软件获取数据包，比如Wireshark。我在服务器配置了Apache，开启80端口，比如这样一个HTTP ULR： <a href="http://129.204.152.8:80" target="_blank" rel="noopener">http://129.204.152.8:80</a>。<br>
<code>curl -x 129.204.152.8:8888 http://129.204.152.8 -v</code><br>
<img src="/uploads/images/tinyproxy_stunnel/01.png" alt></p>
<p>可见数据没有加密，而是直接在两台主机间传输，我们希望HTTP传输也是安全的，也就是经过加密的，那么可以使用Stunnel和TinyProxy来混淆HTTP流量。</p>
<p>CentOS安装Stunnel <code>yum install -y stunnel</code></p>
<h4 id="配置服务端server"><a class="markdownIt-Anchor" href="#配置服务端server"></a> 配置服务端Server</h4>
<p><code>vim /etc/stunnel/stunnel.conf</code>，如果stunnel.conf不存在，那么新建一个并添加以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[tinyproxy]</span><br><span class="line">accept = 0.0.0.0:3128</span><br><span class="line">connect = 0.0.0.0:8888</span><br><span class="line">cert = /etc/ssl/cert.pem</span><br><span class="line">key = /etc/ssl/key.pem</span><br></pre></td></tr></table></figure>
<ul>
<li>accept 服务器stunnel监听端口，用于与客户端进行连接</li>
<li>connect 用于告诉stunnel要连接的IP和端口。这需要是TinyProxy监听的IP和端口，<code>netstat -anpl|grep tinyproxy</code>可看到</li>
<li>cert 本地证书文件路径，可以用<code>openssl</code>生成</li>
<li>key 本地密匙文件路径</li>
</ul>
<h5 id="创建自签名证书"><a class="markdownIt-Anchor" href="#创建自签名证书"></a> 创建自签名证书</h5>
<p>要启动stunnel，那还需要创建自签名证书。</p>
<p>生成key.pem</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># openssl genrsa -out /etc/ssl/key.pem 4096</span></span><br><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">......................................................................++</span><br><span class="line">..............................................................++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>
<p>这将创建一个<code>4096</code>位RSA密钥<code>key.pem</code>。有兴趣的可以了解下<a href="https://danielpocock.com/rsa-key-sizes-2048-or-4096-bits/" target="_blank" rel="noopener">&quot;RSA Key Sizes: 2048 or 4096 bits?&quot;</a></p>
<p>生成cert.pem</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># openssl req -new -x509 -key /etc/ssl/key.pem -out /etc/ssl/cert.pem -days 1826</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:US</span><br><span class="line">State or Province Name (full name) []:Arizona</span><br><span class="line">Locality Name (eg, city) [Default City]:Phoenix</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (eg, your name or your server<span class="string">'s hostname) []:VM_0_17_centos</span></span><br><span class="line"><span class="string">Email Address []:helloworld@example.com          </span></span><br><span class="line"><span class="string">[root@VM_0_17_centos ~]# ls -lh /etc/ssl/</span></span><br><span class="line"><span class="string">total 8.0K</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 2.1K Feb 17 11:03 cert.pem</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root   16 Feb  6 11:56 certs -&gt; ../pki/tls/certs</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root root 3.2K Feb 17 10:55 key.pem</span></span><br></pre></td></tr></table></figure>
<ul>
<li>new x509 创建一个新的X509证书</li>
<li>days 证书的有效期</li>
<li>key 密匙文件</li>
<li>out 输出到cert.pem</li>
</ul>
<p>生成的同时还要回答一些问题</p>
<ul>
<li>Country Name 国家 (PL,UK,US,CA)</li>
<li>State or Province Name 州或省 (Illinois,Ontario,…)</li>
<li>Locality Name 地区 (Chicago,Toronto,…)</li>
<li>Organization Name 组织</li>
<li>Organizational Unit Name 组织单位</li>
<li>Common Name (your name or your server’s hostname) 一般服务器hostname</li>
<li>Email Address 电子邮件</li>
</ul>
<p>启动stunnel <code>stunnel /etc/stunnel/stunnel.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]# netstat -antpl|grep stunnel</span><br><span class="line">tcp        0      0 0.0.0.0:3128            0.0.0.0:*               LISTEN      24263/stunnel</span><br></pre></td></tr></table></figure>
<h4 id="配置客户端client"><a class="markdownIt-Anchor" href="#配置客户端client"></a> 配置客户端Client</h4>
<p>配置完服务器还需要配置本地客户端，就拿Arch/Manjaro举例。<br>
安装stunnel <code>pacman -S stunnel</code></p>
<p><code>cp /etc/stunnel/stunnel.conf-sample /etc/stunnel/stunnel.conf</code><br>
<code>vim /etc/stunnel/stunnel.conf</code><br>
编辑配置文件stunnel.conf可以全部删除只添加以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[tinyproxy]</span><br><span class="line">client = yes</span><br><span class="line">accept = 0.0.0.0:3129</span><br><span class="line">connect = 129.204.152.8:3128</span><br><span class="line">verify = 3</span><br><span class="line">CAfile = /etc/stunnel/cert.pem</span><br></pre></td></tr></table></figure>
<ul>
<li>client 表明这是客户端</li>
<li>accept 本地stunnel监听ip地址+端口 0.0.0.0:xxxx</li>
<li>connect 要连接到远程stunnel服务器</li>
<li>verify  证书验证级别，verify=3根据本地安装的证书并验证证书</li>
<li>CAfile 服务器上生成的<code>cert.pem</code>，将其复制到本地/etc/stunnel/cert.pem</li>
</ul>
<p>之后就可以启动stunnel了，<code>stunnel /etc/stunnel/stunnel.conf</code>，也可以 <code>systemctl start stunnel.service</code>、<code>systemctl enable stunnel.service</code></p>
<h5 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">% curl -x 127.0.0.1:3129 https://ip.cn --head</span><br><span class="line">HTTP/1.0 200 Connection established</span><br><span class="line">Proxy-agent: tinyproxy/1.8.3</span><br><span class="line"></span><br><span class="line">HTTP/2 200 </span><br><span class="line">date: Mon, 17 Feb 2020 03:58:29 GMT</span><br><span class="line">content-type: application/json; charset=UTF-8</span><br><span class="line"><span class="built_in">set</span>-cookie: __cfduid=d340c54d6fa045689f6f49e91ac7f918f1581911909; expires=Wed, 18-Mar-20 03:58:29 GMT; path=/; domain=.ip.cn; HttpOnly; SameSite=Lax</span><br><span class="line">cf-cache-status: DYNAMIC</span><br><span class="line">expect-ct: max-age=604800, report-uri=<span class="string">"https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"</span></span><br><span class="line">server: cloudflare</span><br><span class="line">cf-ray: 5664d7d91e5d77b8-LAX</span><br></pre></td></tr></table></figure>
<p><code>curl -x 127.0.0.1:3129 http://129.204.152.8 -v</code><br>
<img src="/uploads/images/tinyproxy_stunnel/02.png" alt></p>
<p>可见成功的搭建了一个基于TLS的HTTP/HTTPS代理。</p>
<h3 id="windows-stunnel"><a class="markdownIt-Anchor" href="#windows-stunnel"></a> Windows Stunnel</h3>
<p>对于Windows系统，可以从 <a href="https://www.stunnel.org/downloads.html" target="_blank" rel="noopener">https://www.stunnel.org/downloads.html</a> 下载Windows版本的stunnel，首次启动stunnel要回答一些问题来创建默认的<code>stunnel.pem</code>。<br>
现在将服务器生成的<code>cert.pem</code>复制到Windows stunnel配置文件目录。<br>
<img src="/uploads/images/tinyproxy_stunnel/03.png" alt></p>
<p>然后编辑配置文件<code>stunnel.conf</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">debug = info</span><br><span class="line">output = stunnel.log</span><br><span class="line"></span><br><span class="line">[tinyproxy]</span><br><span class="line">client = yes</span><br><span class="line">accept = 6666</span><br><span class="line">connect = 129.204.152.8:3128</span><br><span class="line">;CAfile = cert.pem</span><br><span class="line">cert = cert.pem</span><br><span class="line">key = cert.pem</span><br><span class="line">verify = 3</span><br></pre></td></tr></table></figure>
<p>最后启动stunnel，成功。<br>
<img src="/uploads/images/tinyproxy_stunnel/04.png" alt></p>
<p>stunnel官网在线帮助手册: <a href="https://www.stunnel.org/static/stunnel.html" target="_blank" rel="noopener">https://www.stunnel.org/static/stunnel.html</a><br>
以上便是代理服务器的配置～</p>
<h3 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h3>
<p><a href="https://github.com/tinyproxy/tinyproxy/wiki" target="_blank" rel="noopener">Tinyproxy Wiki</a><br>
<a href="http://kb.ictbanking.net/article.php?id=380" target="_blank" rel="noopener">Using stunnel and TinyProxy to obfuscate HTTP traffic</a><br>
<a href="https://blog.csdn.net/qq_39702947/article/details/87714520" target="_blank" rel="noopener">Windows系统Stunnel使用简介</a></p>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    
      <div>
        <div id="reward-container">
  <div>Give a rose, leave a handful of fragrance; life is not easy, I use the arch</div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">

    
      
      
        
      
      <div style="display: inline-block">
        <img src="/images/wechatpay.png" alt="Joseph XRays 微信支付">
        <p>微信支付</p>
      </div>
    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"> <i class="fa fa-tag"></i> Linux</a>
          
            <a href="/tags/CentOS/" rel="tag"> <i class="fa fa-tag"></i> CentOS</a>
          
            <a href="/tags/TinyProxy/" rel="tag"> <i class="fa fa-tag"></i> TinyProxy</a>
          
            <a href="/tags/HTTP/" rel="tag"> <i class="fa fa-tag"></i> HTTP</a>
          
            <a href="/tags/HTTPS/" rel="tag"> <i class="fa fa-tag"></i> HTTPS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/linux-ban-nvidia/" rel="next" title="Manjaro/Arch禁用独显">
                <i class="fa fa-chevron-left"></i> Manjaro/Arch禁用独显
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/lzw-cpp/" rel="prev" title="LZW文本压缩">
                LZW文本压缩 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMTkwNC84NDY4"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
    <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Joseph XRays">
  
  <p class="site-author-name" itemprop="name">Joseph XRays</p>
  <div class="site-description motion-element" itemprop="description">Share the knowledge</div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>





  <div class="links-of-author motion-element">
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://github.com/josexy" title="GitHub &rarr; https://github.com/josexy" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
    
  </div>






  <div class="links-of-blogroll motion-element links-of-blogroll-block">
    <div class="links-of-blogroll-title">
      <i class="fa  fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
      
        <li class="links-of-blogroll-item">
          <a href="https://github.com/josexy" title="https://github.com/josexy" rel="noopener" target="_blank">Github</a>
        </li>
      
    </ul>
  </div>


          
          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#tinyproxy"><span class="nav-number">1.</span> <span class="nav-text"> TinyProxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stunnel隧道"><span class="nav-number">2.</span> <span class="nav-text"> Stunnel(隧道)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置服务端server"><span class="nav-number">2.1.</span> <span class="nav-text"> 配置服务端Server</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#创建自签名证书"><span class="nav-number">2.1.1.</span> <span class="nav-text"> 创建自签名证书</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置客户端client"><span class="nav-number">2.2.</span> <span class="nav-text"> 配置客户端Client</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#测试"><span class="nav-number">2.2.1.</span> <span class="nav-text"> 测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows-stunnel"><span class="nav-number">3.</span> <span class="nav-text"> Windows Stunnel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text"> 参考</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Joseph XRays</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">309k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">4:41</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  



  











  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.2.0"></script>



  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  


  
    


<script>
  window.livereOptions = {
    refer: 'linux-tinyproxy/'
  };
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

   


  



<script type="text/javascript" src="/js/float_wenzi.js"></script>
</body>
</html>



